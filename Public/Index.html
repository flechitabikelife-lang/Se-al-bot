<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SignalBot Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#080b10;--surface:#0e1420;--s2:#161d2e;--border:rgba(255,255,255,0.07);--green:#00e676;--red:#ff4d6d;--yellow:#ffd166;--text:#e8eaf6;--dim:#5c6580}
    body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;padding:20px 16px}
    body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 0%,rgba(0,230,118,0.04),transparent);pointer-events:none}
    .wrap{max-width:860px;margin:0 auto;position:relative}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:38px;height:38px;background:var(--green);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
    h1{font-size:1.4rem;font-weight:800}
    h1 span{color:var(--green)}
    #badge{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:100px;font-size:.8rem;font-family:'DM Mono',monospace;font-weight:600;background:var(--s2);border:1px solid var(--border);transition:all .3s}
    #badge .dot{width:8px;height:8px;border-radius:50%;background:var(--dim);transition:all .3s}
    #badge.conectado{background:rgba(0,230,118,.12);border-color:rgba(0,230,118,.3);color:var(--green)}
    #badge.conectado .dot{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
    #badge.esperando_qr{background:rgba(255,209,102,.12);border-color:rgba(255,209,102,.3);color:var(--yellow)}
    #badge.esperando_qr .dot{background:var(--yellow)}
    #badge.desconectado{background:rgba(255,77,109,.12);border-color:rgba(255,77,109,.3);color:var(--red)}
    #badge.desconectado .dot{background:var(--red)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;margin-bottom:16px}
    .card-title{font-size:.7rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:18px}
    #qrSection{display:none;text-align:center;padding:8px 0}
    #qrSection p{color:var(--yellow);font-size:.9rem;margin-bottom:14px}
    #qrImg{width:200px;height:200px;border-radius:12px;border:3px solid var(--yellow);padding:6px;background:#fff}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;border-radius:10px;font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;border:none;transition:all .2s}
    .btn:active{transform:scale(.97)}
    .btn:disabled{opacity:.4;cursor:not-allowed}
    .btn-green{background:var(--green);color:#000}
    .btn-green:hover:not(:disabled){background:#00ff85;box-shadow:0 4px 20px rgba(0,230,118,.3)}
    .btn-red{background:var(--red);color:#fff}
    .btn-red:hover:not(:disabled){box-shadow:0 4px 20px rgba(255,77,109,.3)}
    .btn-ghost{background:var(--s2);color:var(--text);border:1px solid var(--border)}
    .btn-ghost:hover:not(:disabled){border-color:rgba(255,255,255,.2)}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}
    .ig{margin-bottom:14px}
    label{display:block;font-size:.75rem;font-weight:700;color:var(--dim);margin-bottom:6px;letter-spacing:.5px;text-transform:uppercase}
    input,select,textarea{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:11px 15px;color:var(--text);font-family:'Syne',sans-serif;font-size:.93rem;outline:none;transition:border-color .2s}
    input:focus,select:focus,textarea:focus{border-color:var(--green)}
    textarea{resize:vertical;min-height:85px}
    select option{background:var(--s2)}
    #historialList{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow-y:auto}
    .hi{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 15px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .hi-msg{font-size:.9rem;flex:1}
    .hi-meta{font-size:.72rem;color:var(--dim);font-family:'DM Mono',monospace;white-space:nowrap}
    .hi-tipo{font-size:.68rem;padding:3px 8px;border-radius:100px;font-weight:700}
    .hi-tipo.manual{background:rgba(76,201,240,.15);color:#4cc9f0}
    .hi-tipo.automatica{background:rgba(0,230,118,.15);color:var(--green)}
    .toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:12px;font-size:.88rem;font-weight:700;opacity:0;transform:translateY(10px);transition:all .3s;z-index:999;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.ok{background:var(--green);color:#000}
    .toast.err{background:var(--red);color:#fff}
    #grupoSelect{display:none;margin-top:14px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <div class="logo-icon">ü§ñ</div>
      <h1>Signal<span>Bot</span></h1>
    </div>
    <div id="badge">
      <div class="dot"></div>
      <span id="badgeText">Desconectado</span>
    </div>
  </header>

  <!-- CONEXI√ìN -->
  <div class="card">
    <div class="card-title">üì° Conexi√≥n WhatsApp</div>
    <div id="qrSection">
      <p>üì± Escanea el QR con tu WhatsApp</p>
      <img id="qrImg" src="" alt="QR"/>
    </div>
    <div class="btn-row">
      <button class="btn btn-green" id="btnConectar" onclick="conectar()">‚ö° Conectar Bot</button>
      <button class="btn btn-red" id="btnDesconectar" onclick="desconectar()" disabled>üîå Desconectar</button>
    </div>
  </div>

  <!-- GRUPO -->
  <div class="card">
    <div class="card-title">üë• Configurar Grupo</div>
    <button class="btn btn-ghost" onclick="cargarGrupos()">üîÑ Cargar mis grupos</button>
    <div id="grupoSelect">
      <div class="ig" style="margin-top:14px">
        <label>Selecciona el grupo</label>
        <select id="selectGrupo"></select>
      </div>
      <button class="btn btn-green" onclick="configurarGrupo()">‚úÖ Guardar grupo</button>
    </div>
  </div>

  <!-- ENV√çO MANUAL -->
  <div class="card">
    <div class="card-title">üì§ Enviar Se√±al Manual</div>
    <div class="ig">
      <label>Mensaje de se√±al</label>
      <textarea id="msgManual" placeholder="Ej: üü¢ SE√ëAL ACTIVA - Apuesta ahora en Aviator x2.5 ‚úàÔ∏è"></textarea>
    </div>
    <button class="btn btn-green" onclick="enviarManual()">üöÄ Enviar Se√±al</button>
  </div>

  <!-- ENV√çO AUTOM√ÅTICO -->
  <div class="card">
    <div class="card-title">‚è± Se√±ales Autom√°ticas</div>
    <div class="ig">
      <label>Mensaje autom√°tico</label>
      <textarea id="msgAuto" placeholder="Ej: ‚úàÔ∏è SE√ëAL ‚Äî Juega ahora Aviator | Multiplicador: x2 üéØ"></textarea>
    </div>
    <div class="ig">
      <label>Cada cu√°ntos minutos</label>
      <input type="number" id="intervalo" value="5" min="1" max="60"/>
    </div>
    <div class="btn-row">
      <button class="btn btn-green" onclick="iniciarAuto()">‚ñ∂Ô∏è Iniciar autom√°tico</button>
      <button class="btn btn-red" onclick="detenerAuto()">‚èπ Detener</button>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="card">
    <div class="card-title">üìã √öltimas se√±ales enviadas</div>
    <div id="historialList"><p style="color:var(--dim);font-size:.9rem">Cargando...</p></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = '';

  function toast(msg, tipo='ok'){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast show ${tipo}`;
    setTimeout(() => t.className = 'toast', 3000);
  }

  async function actualizarStatus(){
    try {
      const r = await fetch(API + '/api/status');
      const d = await r.json();
      const badge = document.getElementById('badge');
      const badgeText = document.getElementById('badgeText');
      const qrSection = document.getElementById('qrSection');
      const qrImg = document.getElementById('qrImg');
      const btnC = document.getElementById('btnConectar');
      const btnD = document.getElementById('btnDesconectar');

      badge.className = d.status;
      badgeText.textContent = d.status === 'conectado' ? 'Conectado' : d.status === 'esperando_qr' ? 'Esperando QR' : 'Desconectado';

      if(d.qr){
        qrSection.style.display = 'block';
        qrImg.src = d.qr;
      } else {
        qrSection.style.display = 'none';
      }

      btnC.disabled = d.status !== 'desconectado';
      btnD.disabled = d.status === 'desconectado';
    } catch(e){}
  }

  async function conectar(){
    await fetch(API + '/api/conectar', {method:'POST'});
    toast('Iniciando conexi√≥n...');
  }

  async function desconectar(){
    await fetch(API + '/api/desconectar', {method:'POST'});
    toast('Bot desconectado', 'err');
  }

  async function cargarGrupos(){
    const r = await fetch(API + '/api/grupos');
    const d = await r.json();
    if(!d.ok) return toast(d.msg, 'err');
    const sel = document.getElementById('selectGrupo');
    sel.innerHTML = d.grupos.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
    document.getElementById('grupoSelect').style.display = 'block';
  }

  async function configurarGrupo(){
    const id = document.getElementById('selectGrupo').value;
    const r = await fetch(API + '/api/grupo', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
    const d = await r.json();
    toast(d.ok ? '‚úÖ Grupo guardado!' : d.msg, d.ok ? 'ok' : 'err');
  }

  async function enviarManual(){
    const mensaje = document.getElementById('msgManual').value.trim();
    if(!mensaje) return toast('Escribe un mensaje', 'err');
    const r = await fetch(API + '/api/enviar', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mensaje})});
    const d = await r.json();
    toast(d.ok ? 'üöÄ Se√±al enviada!' : d.msg, d.ok ? 'ok' : 'err');
    if(d.ok) cargarHistorial();
  }

  async function iniciarAuto(){
    const mensaje = document.getElementById('msgAuto').value.trim();
    const intervaloMinutos = parseInt(document.getElementById('intervalo').value);
    if(!mensaje) return toast('Escribe el mensaje autom√°tico', 'err');
    const r = await fetch(API + '/api/automatico/iniciar', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mensaje, intervaloMinutos})});
    const d = await r.json();
    toast(d.ok ? `‚ñ∂Ô∏è Enviando cada ${intervaloMinutos} min` : d.msg, d.ok ? 'ok' : 'err');
  }

  async function detenerAuto(){
    const r = await fetch(API + '/api/automatico/detener', {method:'POST'});
    const d = await r.json();
    toast('‚èπ Se√±ales autom√°ticas detenidas', 'err');
  }

  async function cargarHistorial(){
    const r = await fetch(API + '/api/historial');
    const d = await r.json();
    const lista = document.getElementById('historialList');
    if(!d.ok || !d.senales.length){
      lista.innerHTML = '<p style="color:var(--dim);font-size:.9rem">Sin se√±ales enviadas a√∫n</p>';
      return;
    }
    lista.innerHTML = d.senales.map(s => `
      <div class="hi">
        <span class="hi-msg">${s.mensaje}</span>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <span class="hi-tipo ${s.tipo}">${s.tipo}</span>
          <span class="hi-meta">${s.timestamp}</span>
        </div>
      </div>
    `).join('');
  }

  setInterval(actualizarStatus, 3000);
  actualizarStatus();
  cargarHistorial();
</script>
</body>
</html>
